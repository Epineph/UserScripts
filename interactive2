#!/bin/bash

# Display introductory message
echo "Arch Linux Installation with RAID, LVM, and Swap"

# Check if [multilib] is enabled
IS_MULTILIB_REPO_DISABLED=$(grep -E "#\[multilib\]" /etc/pacman.conf | wc -l)
if [ "$IS_MULTILIB_REPO_DISABLED" -eq "1" ]; then
    echo "Enable [multilib] in /etc/pacman.conf before running this script."
    exit 1
fi
echo "[multilib] correctly enabled, continuing"

# Sync time
timedatectl set-ntp true

# Update mirrors
pacman -Syyy

# Install required utilities
pacman -S fzf mdadm lvm2 --noconfirm

# Hardcoded selection of NVMe and SATA partitions (example partitions, update to your actual partitions)
nvme_partition="/dev/nvme0n1p1"
sata_partition="/dev/sda1"

# Verify that both partitions are available
if [ ! -e "$nvme_partition" ] || [ ! -e "$sata_partition" ]; then
    echo "Both partitions need to exist: NVMe ($nvme_partition) and SATA ($sata_partition)"
    exit 1
fi

# RAID Configuration
echo "Setting up RAID-0 (striping) with NVMe and SATA"
mdadm --create --verbose /dev/md0 --level=0 --raid-devices=2 $nvme_partition $sata_partition

# LVM Setup
echo "Setting up LVM on RAID array"
pvcreate /dev/md0
vgcreate volgroup0 /dev/md0
lvcreate -L 80GB volgroup0 -n lv_root
lvcreate -L 16GB volgroup0 -n lv_swap
lvcreate -l 100%FREE volgroup0 -n lv_home

# Format partitions
yes | mkfs.ext4 /dev/volgroup0/lv_root
yes | mkfs.ext4 /dev/volgroup0/lv_home

# Format and enable swap
mkswap /dev/volgroup0/lv_swap
swapon /dev/volgroup0/lv_swap

# Format EFI partition separately if required
echo "Formatting EFI partition (assuming it's part of NVMe)"
yes | mkfs.fat -F32 /dev/nvme0n1p1

# Mount partitions
mount /dev/volgroup0/lv_root /mnt
mkdir -p /mnt/boot /mnt/home
mount /dev/nvme0n1p1 /mnt/boot
mount /dev/volgroup0/lv_home /mnt/home

# Pacstrap desired packages
pacstrap /mnt base base-devel ...

# Continue with remaining installation steps...